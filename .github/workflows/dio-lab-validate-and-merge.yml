name: DIO Lab Workflow

on:
  pull_request_target:
    types:
      - opened
      - synchronize

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-and-comment:
    runs-on: ubuntu-latest

    steps:   
    - name: Checkout code from PR (Safe Checkout)
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Install GitHub CLI
      uses: cli/gh-install@v1

    - name: Validate PR
      run: |
        AUTHOR_NAME="${{ github.event.pull_request.user.login }}"
        FILE_PATH="community/$AUTHOR_NAME.md"
        
        files_changed=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --paginate | jq -r '.[].filename')
    
        echo "Changed files:"
        echo "$files_changed"
        
        NUM_CHANGED_FILES=$(echo "$files_changed" | wc -l)
        
        if [[ "$NUM_CHANGED_FILES" -eq 1 && "$files_changed" == "$FILE_PATH" ]]; then
            echo "PR is valid, only the expected file has been changed."
        else
            echo "ERROR: Invalid PR. More or different files than expected were changed."
            exit 1
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment PR on Success and Add Label [automerge]
      if: success()
      run: |
        REPO_URL=${{ github.event.pull_request.h
